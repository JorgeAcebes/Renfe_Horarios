<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renfe Coslada - Vicálvaro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: white;
            color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
        }
        
        .container {
            text-align: center;
            border: 2px solid black;
            padding: 40px;
            background-color: white;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .time-info {
            background-color: transparent;
            color: black;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            text-align: center;
        }
        
        button {
            background-color: black;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s;
            margin: 5px;
            min-width: 250px;
        }
        
        button:hover {
            background-color: white;
            color: black;
            border: 2px solid black;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .buttons-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .edit-btn {
            background-color: white;
            color: black;
            border: 1px solid black;
            padding: 8px 16px;
            font-size: 12px;
            margin-top: 15px;
        }
        
        .edit-btn:hover {
            background-color: black;
            color: white;
        }
        
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .edit-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border: 2px solid black;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .route-item {
            display: flex;
            align-items: stretch;
            margin-bottom: 15px;
            padding: 8px;
            border: 1px solid black;
            gap: 8px;
            cursor: move;
            user-select: none;
        }
        
        .route-item.dragging {
            opacity: 0.5;
        }
        
        .route-item.drag-over {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        
        .route-item.hidden-route {
            background-color: #f5f5f5;
            opacity: 0.7;
        }
        
        .drag-handle {
            display: flex;
            align-items: center;
            padding: 0 8px;
            cursor: move;
            font-size: 14px;
            color: #666;
            flex-shrink: 0;
        }
        
        .route-name {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            font-family: Arial;
            font-size: 14px;
            min-width: 150px;
        }
        
        .route-controls {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .control-btn {
            background-color: black;
            color: white;
            border: none;
            padding: 6px 8px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            width: auto;
            min-width: auto;
            transition: background-color 0.2s;
        }
        
        .control-btn:hover {
            background-color: #333;
        }
        
        .visibility-btn {
            background-color: #007bff;
        }
        
        .visibility-btn:hover {
            background-color: #0056b3;
        }
        
        .visibility-btn.hidden {
            background-color: #6c757d;
        }
        
        .visibility-btn.hidden:hover {
            background-color: #545b62;
        }
        
        .delete-btn {
            background-color: #dc3545;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .add-route-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid black;
        }
        
        .add-route-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .add-route-section p {
            font-size: 12px;
            margin-bottom: 15px;
            color: #666;
        }
        
        .new-route-input {
            width: 100%;
            padding: 8px;
            border: 1px solid black;
            margin-bottom: 10px;
            font-family: Arial;
            box-sizing: border-box;
        }
        
        .modal-buttons {
            display: flex;
            flex-direction: column;
            margin-top: 20px;
            gap: 10px;
        }
        
        .save-btn, .cancel-btn, .add-route-btn, .reset-btn {
            padding: 12px 15px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }
        
        .save-btn {
            background-color: black;
            color: white;
        }
        
        .cancel-btn {
            background-color: white;
            color: black;
            border: 1px solid black;
        }
        
        .add-route-btn {
            background-color: black;
            color: white;
        }
        
        .reset-btn {
            background-color: #dc3545;
            color: white;
            margin-top: 10px;
        }
        
        .reset-btn:hover {
            background-color: #c82333;
        }
        
        .auto-redirect {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            display: none;
        }
        
        .countdown {
            font-weight: bold;
            color: black;
        }
        
        .storage-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 11px;
            color: #888;
            text-align: center;
        }
        
        .section-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RENFE CERCANÍAS MADRID</h1>
        
        <div class="buttons-container" id="buttonsContainer">
            <!-- Los botones se generarán dinámicamente -->
        </div>
        
        <button class="edit-btn" id="editBtn">✏️ EDITAR TRAYECTOS</button>
        
        <div class="storage-info">
            Los trayectos se guardan localmente en tu navegador
        </div>
    </div>
    
    <div class="time-info">
        <div id="current-date"></div>
        <div id="current-time"></div>
    </div>
    
    <!-- Modal de edición -->
    <div class="edit-modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">EDITAR TRAYECTOS</div>
            
            <div id="routesList"></div>
            
            <div class="add-route-section">
                <h3>AÑADIR NUEVO TRAYECTO</h3>
                <p>Pega aquí el enlace completo de Renfe con el trayecto deseado:</p>
                <input type="text" class="new-route-input" id="newRouteName" placeholder="Nombre del trayecto (ej: MADRID → BARCELONA)" />
                <input type="text" class="new-route-input" id="newRouteUrl" placeholder="https://www.renfe.com/es/es/cercanias/..." />
                <button class="add-route-btn" id="addRouteBtn">AÑADIR TRAYECTO</button>
            </div>
            
            <div class="modal-buttons">
                <button class="save-btn" id="saveBtn">GUARDAR CAMBIOS</button>
                <button class="cancel-btn" id="cancelBtn">CANCELAR</button>
                <button class="reset-btn" id="resetBtn">RESTABLECER VALORES POR DEFECTO</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración por defecto
        const DEFAULT_ROUTES = {
            'coslada-vicalvaro': {
                name: 'COSLADA → VICÁLVARO',
                originValue: '100070108',
                originText: 'Coslada',
                destinationValue: '100070100',
                destinationText: 'Vic%C3%A1lvaro',
                visible: true,
                order: 0
            },
            'vicalvaro-coslada': {
                name: 'VICÁLVARO → COSLADA',
                originValue: '100070100',
                originText: 'Vic%C3%A1lvaro',
                destinationValue: '100070108',
                destinationText: 'Coslada',
                visible: true,
                order: 1
            },
            'universidad-coslada': {
                name: 'UNIVERSIDAD → COSLADA',
                originValue: '100017009',
                originText: 'Universidad+Cantoblanco',
                destinationValue: '100070108',
                destinationText: 'Coslada',
                visible: true,
                order: 2
            }
        };

        // Estado de rutas (se carga desde localStorage)
        let routes = {};
        let draggedElement = null;

        // Funciones de almacenamiento local
        function saveRoutesToStorage() {
            try {
                localStorage.setItem('renfe_routes', JSON.stringify(routes));
                console.log('Rutas guardadas en localStorage');
            } catch (error) {
                console.error('Error al guardar en localStorage:', error);
                alert('Error al guardar los cambios. Puede que tu navegador tenga el almacenamiento local deshabilitado.');
            }
        }

        function loadRoutesFromStorage() {
            try {
                const savedRoutes = localStorage.getItem('renfe_routes');
                if (savedRoutes) {
                    routes = JSON.parse(savedRoutes);
                    
                    // Migrar rutas antiguas que no tengan las nuevas propiedades
                    let needsUpdate = false;
                    Object.keys(routes).forEach((routeId, index) => {
                        if (routes[routeId].visible === undefined) {
                            routes[routeId].visible = true;
                            needsUpdate = true;
                        }
                        if (routes[routeId].order === undefined) {
                            routes[routeId].order = index;
                            needsUpdate = true;
                        }
                    });
                    
                    if (needsUpdate) {
                        saveRoutesToStorage();
                    }
                    
                    console.log('Rutas cargadas desde localStorage');
                } else {
                    // Si no hay rutas guardadas, usar las por defecto
                    routes = { ...DEFAULT_ROUTES };
                    saveRoutesToStorage();
                    console.log('Usando rutas por defecto y guardándolas');
                }
            } catch (error) {
                console.error('Error al cargar desde localStorage:', error);
                routes = { ...DEFAULT_ROUTES };
                console.log('Error de localStorage, usando rutas por defecto');
            }
        }

        function resetToDefaultRoutes() {
            if (confirm('¿Estás seguro de que quieres restablecer todos los trayectos a los valores por defecto? Se perderán todos tus cambios personalizados.')) {
                routes = { ...DEFAULT_ROUTES };
                saveRoutesToStorage();
                renderButtons();
                renderEditModal();
                alert('Trayectos restablecidos a los valores por defecto.');
            }
        }

        function getRouteURL(routeId) {
            const now = new Date();
            
            // Formato de fecha para la URL (DD-MM-YYYY)
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const dateForURL = `${day}-${month}-${year}`;
            
            // Formato de hora para la URL (HH:MM)
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timeForURL = `${hours}%3A${minutes}`;
            
            const route = routes[routeId];
            if (!route) return '';
            
            const baseURL = 'https://www.renfe.com/es/es/cercanias/cercanias-madrid/horarios#/listado?tripType=station';
            
            return `${baseURL}&originInputValue=${route.originValue}&originInputText=${route.originText}&destinationInputValue=${route.destinationValue}&destinationInputText=${route.destinationText}&tripPreferences=todas&whenToDepartType=1&deptDate=${dateForURL}&deptTime=${timeForURL}`;
        }
        
        function extractRouteFromUrl(url) {
            try {
                const urlObj = new URL(url);
                const hash = urlObj.hash;
                const params = new URLSearchParams(hash.split('?')[1] || '');
                
                return {
                    originValue: params.get('originInputValue') || '',
                    originText: params.get('originInputText') || '',
                    destinationValue: params.get('destinationInputValue') || '',
                    destinationText: params.get('destinationInputText') || ''
                };
            } catch (e) {
                return null;
            }
        }
        
        function getSortedRoutes() {
            return Object.keys(routes)
                .sort((a, b) => {
                    const orderA = routes[a].order !== undefined ? routes[a].order : 999;
                    const orderB = routes[b].order !== undefined ? routes[b].order : 999;
                    return orderA - orderB;
                });
        }
        
        function getVisibleRoutes() {
            return getSortedRoutes().filter(routeId => routes[routeId].visible !== false);
        }
        
        function renderButtons() {
            const container = document.getElementById('buttonsContainer');
            container.innerHTML = '';
            
            const visibleRoutes = getVisibleRoutes();
            
            visibleRoutes.forEach(routeId => {
                const button = document.createElement('button');
                button.className = 'route-btn';
                button.setAttribute('data-route', routeId);
                button.textContent = routes[routeId].name;
                container.appendChild(button);
                
                button.addEventListener('click', function() {
                    redirectToRenfe(routeId);
                });
            });
        }
        
        function toggleRouteVisibility(routeId) {
            if (routes[routeId]) {
                routes[routeId].visible = !routes[routeId].visible;
                renderEditModal();
            }
        }
        
        function updateRouteOrder() {
            const routeItems = document.querySelectorAll('.route-item');
            routeItems.forEach((item, index) => {
                const routeId = item.getAttribute('data-route');
                if (routes[routeId]) {
                    routes[routeId].order = index;
                }
            });
        }
        
        function renderEditModal() {
            const routesList = document.getElementById('routesList');
            routesList.innerHTML = '';
            
            const sortedRoutes = getSortedRoutes();
            
            sortedRoutes.forEach(routeId => {
                const route = routes[routeId];
                const routeItem = document.createElement('div');
                routeItem.className = `route-item ${!route.visible ? 'hidden-route' : ''}`;
                routeItem.setAttribute('data-route', routeId);
                routeItem.draggable = true;
                
                const visibilityIcon = route.visible ? '👁️' : '👁️‍🗨️';
                const visibilityClass = route.visible ? '' : 'hidden';
                
                routeItem.innerHTML = `
                    <div class="drag-handle">⋮⋮</div>
                    <input type="text" class="route-name" value="${route.name}" data-route="${routeId}" />
                    <div class="route-controls">
                        <button class="control-btn visibility-btn ${visibilityClass}" data-route="${routeId}" title="${route.visible ? 'Ocultar trayecto' : 'Mostrar trayecto'}">${visibilityIcon}</button>
                        <button class="control-btn delete-btn" data-route="${routeId}" title="Eliminar trayecto">🗑️</button>
                    </div>
                `;
                routesList.appendChild(routeItem);
                
                // Event listeners para drag and drop
                routeItem.addEventListener('dragstart', handleDragStart);
                routeItem.addEventListener('dragover', handleDragOver);
                routeItem.addEventListener('drop', handleDrop);
                routeItem.addEventListener('dragend', handleDragEnd);
            });
            
            // Event listeners para controles
            document.querySelectorAll('.visibility-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const routeId = this.getAttribute('data-route');
                    toggleRouteVisibility(routeId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const routeId = this.getAttribute('data-route');
                    if (confirm('¿Estás seguro de que quieres eliminar este trayecto?')) {
                        delete routes[routeId];
                        renderEditModal();
                    }
                });
            });
        }
        
        // Funciones de drag and drop
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedElement !== this) {
                const routesList = document.getElementById('routesList');
                const draggedIndex = Array.from(routesList.children).indexOf(draggedElement);
                const targetIndex = Array.from(routesList.children).indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    routesList.insertBefore(draggedElement, this.nextSibling);
                } else {
                    routesList.insertBefore(draggedElement, this);
                }
                
                updateRouteOrder();
            }
            
            this.classList.remove('drag-over');
        }
        
        function handleDragEnd(e) {
            document.querySelectorAll('.route-item').forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });
            draggedElement = null;
        }
        
        function updateDateTime() {
            const now = new Date();
            
            // Formato de fecha para la URL (DD-MM-YYYY)
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            
            // Formato de hora para la URL (HH:MM)
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            // Mostrar fecha y hora en la página
            document.getElementById('current-date').textContent = `FECHA: ${day}/${month}/${year}`;
            document.getElementById('current-time').textContent = `HORA: ${hours}:${minutes}`;
        }
        
        function redirectToRenfe(route = 'coslada-vicalvaro') {
            const url = getRouteURL(route);
            if (url) {
                window.open(url, '_blank');
            }
        }
        
        // Inicialización de la aplicación
        function initApp() {
            loadRoutesFromStorage();
            renderButtons();
            updateDateTime();
        }
        
        // Actualizar fecha y hora cada segundo
        setInterval(updateDateTime, 1000);
        
        // Inicializar la app al cargar
        initApp();
        
        // Event listeners para el modal
        document.getElementById('editBtn').addEventListener('click', function() {
            renderEditModal();
            document.getElementById('editModal').classList.add('show');
        });
        
        document.getElementById('cancelBtn').addEventListener('click', function() {
            document.getElementById('editModal').classList.remove('show');
            // Recargar rutas desde localStorage para descartar cambios
            loadRoutesFromStorage();
            renderButtons();
        });
        
        document.getElementById('saveBtn').addEventListener('click', function() {
            // Actualizar nombres de rutas
            document.querySelectorAll('.route-name').forEach(input => {
                const routeId = input.getAttribute('data-route');
                if (routes[routeId]) {
                    routes[routeId].name = input.value.trim() || routes[routeId].name;
                }
            });
            
            // Guardar en localStorage
            saveRoutesToStorage();
            renderButtons();
            document.getElementById('editModal').classList.remove('show');
            
            // Mostrar confirmación
            const originalText = document.getElementById('saveBtn').textContent;
            document.getElementById('saveBtn').textContent = '✓ GUARDADO';
            setTimeout(() => {
                if (document.getElementById('saveBtn')) {
                    document.getElementById('saveBtn').textContent = originalText;
                }
            }, 2000);
        });
        
        document.getElementById('addRouteBtn').addEventListener('click', function() {
            const name = document.getElementById('newRouteName').value.trim();
            const url = document.getElementById('newRouteUrl').value.trim();
            
            if (!name || !url) {
                alert('Por favor, introduce tanto el nombre como la URL del trayecto.');
                return;
            }
            
            const routeData = extractRouteFromUrl(url);
            if (!routeData || !routeData.originValue || !routeData.destinationValue) {
                alert('URL no válida. Asegúrate de que sea un enlace de Renfe con origen y destino.');
                return;
            }
            
            const routeId = 'route_' + Date.now();
            const maxOrder = Math.max(...Object.values(routes).map(r => r.order || 0), -1);
            
            routes[routeId] = {
                name: name,
                originValue: routeData.originValue,
                originText: routeData.originText,
                destinationValue: routeData.destinationValue,
                destinationText: routeData.destinationText,
                visible: true,
                order: maxOrder + 1
            };
            
            document.getElementById('newRouteName').value = '';
            document.getElementById('newRouteUrl').value = '';
            
            renderEditModal();
            alert('Trayecto añadido correctamente. No olvides hacer clic en "GUARDAR CAMBIOS" para que se mantenga permanentemente.');
        });
        
        // Botón de reset
        document.getElementById('resetBtn').addEventListener('click', resetToDefaultRoutes);
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
                // Recargar rutas desde localStorage para descartar cambios
                loadRoutesFromStorage();
                renderButtons();
            }
        });

        // Prevenir pérdida de datos al cerrar la página
        window.addEventListener('beforeunload', function(e) {
            // Solo mostrar advertencia si hay cambios sin guardar
            const currentRoutes = JSON.stringify(routes);
            const savedRoutes = localStorage.getItem('renfe_routes') || JSON.stringify(DEFAULT_ROUTES);
            
            if (currentRoutes !== savedRoutes) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
